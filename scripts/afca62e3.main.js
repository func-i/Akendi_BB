(function(){var a,b,c,d,e,f,g,h,i,j;d=[],j=[],g=null,h=null,f=null,i={$html:$("html"),$instructions:$(".instructions"),$start:$(".instructions .start"),$end:$(".end"),$practiceEnd:$(".practice.end"),$next:$(".practice.end .next"),$sessionEnd:$(".session.end"),$inProgress:$("#in-progress"),$sentenceForm:$("#sentence-form"),$textarea:$("#sentence-form textarea"),$submit:$('#sentence-form input[type="submit"]'),$sentence:$("#sentence"),$admin:$("#admin")},i.$html.on("click",function(a){var b;return a.preventDefault(),i.$textarea.focus(),b=i.$textarea.val().length,i.$textarea[0].setSelectionRange(b,b)}),i.$textarea.on("keydown",function(a){return 8===a.which?a.preventDefault():void 0}),i.$textarea.on("keypress",function(a){var c;return g.isInProgress||g.isFinished||g.start(),g.isInProgress?(c=new b({"char":String.fromCharCode(a.charCode),sentence:g}),g.rawKeypresses.push(c)):void 0}),i.$start.click(function(a){return a.preventDefault(),a.stopPropagation(),e.startTest()}),i.$next.click(function(a){return a.preventDefault(),a.stopPropagation(),i.$practiceEnd.hide(),$(".experiment.instructions").show()}),i.$submit.click(function(a){return a.preventDefault(),a.stopPropagation(),g.stop(),e.outOfTime()?e.stopTest():e.showNextSentence()}),b=function(){function a(a){this.char=a.char,this.sentence=a.sentence,this.index=this.sentence.rawKeypresses.length,this.setTimeSinceStart()}return a.prototype.setTimeSinceStart=function(){var a;return a=(new Date).getTime(),0===this.index&&(this.sentence.startTime=a),this.timeSinceStart=a-this.sentence.startTime},a.prototype.abbrSelf=function(){return{index:this.index,"char":this.char,timeSinceStart:this.timeSinceStart}},a}(),c=function(){function a(a){this.parseObj=a.parseObj,this.isCurrent=!1,this.expectedText=this.parseObj.get("text"),this.isPractice=this.parseObj.get("isPractice"),this.rawKeypresses=[]}return a.prototype.makeCurrent=function(){return g=this,this.loadText()},a.prototype.loadText=function(){return i.$sentence.text(this.expectedText)},a.prototype.setSpeedInWpm=function(){var a,b;return b=this.timeInMs/1e3/60,a=this.actualText.length/5/b,this.speedInWpm=Math.round(100*a)/100},a.prototype.start=function(){return this.isInProgress=!0},a.prototype.stop=function(){return this.timeInMs=(new Date).getTime()-this.startTime,this.actualText=i.$textarea.val(),this.setSpeedInWpm(),this.isInProgress=!1,this.isFinished=!0,e.isPractice?void 0:this.saveToParse()},a.prototype.saveToParse=function(){var a,b,c,d,f,g;for(b=[],g=this.rawKeypresses,d=0,f=g.length;f>d;d++)a=g[d],b.push(a.abbrSelf());return c=new e.parse.objects.Test,c.set("rawKeypresses",b),c.set("testerId",h.id),c.set("actualText",this.actualText),c.set("expectedText",this.expectedText),c.set("timeInMs",this.timeInMs),c.set("speedInWpm",this.speedInWpm),c.save()},a}(),a=function(){function a(){this.initParse(),FastClick.attach(document.body),this.isAdmin()?(this.generateCSVs(),i.$html.off("click")):this.init().then(function(a){return function(){return a.initPractice()}}(this))}return a.prototype.initParse=function(){return Parse.initialize("wn0yAEDFtIJ9Iw3jrL8hBJBeFbjQkVaJvnmY1CS3","KBmFKqYHviQnxPQhQe9U7VOWg5E5LjFFKoqzC7ay"),this.parse={objects:{Sentence:Parse.Object.extend("Sentence"),Test:Parse.Object.extend("Test"),Keypress:Parse.Object.extend("Keypress"),Tester:Parse.Object.extend("Tester"),Config:Parse.Object.extend("Config")},api:{getConfig:function(a){return function(){var b;return b=new Parse.Query(a.parse.objects.Config),b.first()}}(this),createTester:function(a){return function(){var b;return b=new a.parse.objects.Tester,b.save()}}(this),getSentences:function(a){return function(){var b;return b=new Parse.Query(a.parse.objects.Sentence),b.find()}}(this),getTests:function(a){return function(){var b;return b=new Parse.Query(a.parse.objects.Test),b.limit(1e3).find()}}(this)}}},a.prototype.init=function(){return Parse.Promise.when(this.parse.api.getConfig(),this.parse.api.createTester(),this.parse.api.getSentences()).done(function(a){return function(b,e,f){var g,i,j,k,l,m;for(a.config=b,h=e,l=_.shuffle(f),m=[],j=0,k=l.length;k>j;j++)i=l[j],g=new c({parseObj:i}),m.push(d.push(g));return m}}(this))},a.prototype.isAdmin=function(){var a;return a=document.createElement("a"),a.href=window.location,"#admin"===a.hash},a.prototype.maxTime=function(){return this.config.get(this.isPractice?"practiceTime":"experimentTime")},a.prototype.generateCSVs=function(){return this.parse.api.getTests().then(function(a){var b,c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t,u,v,w;for(p=[],j=[],s=0,u=a.length;u>s;s++)for(l=a[s],n=l.id,m={Id:n,"Tester Id":l.get("testerId"),"Actual Text":l.get("actualText"),"Expected Text":l.get("expectedText"),"Time in MS":l.get("timeInMs"),"Speed in WPM":l.get("speedInWpm")},p.push(m),w=l.get("rawKeypresses"),t=0,v=w.length;v>t;t++)f=w[t],g={"Test Id":n,Index:f.index,Character:f.char,"Time in MS since start":f.timeSinceStart},j.push(g);return e=new Date,r=""+e.getFullYear()+"-"+e.getMonth()+"-"+e.getDate()+"-"+e.getTime(),o=JSONToCSVConvertor(p,"Tests",!0),q="data:text/csv;charset=utf-8,"+escape(o),b=$("<div/>"),d=$("<a/>",{href:q,download:"tests-"+r+".csv",html:"Tests","class":"btn btn-success"}).appendTo(b),b.appendTo(i.$admin),h=JSONToCSVConvertor(j,"Raw Keypresses",!0),k="data:text/csv;charset=utf-8,"+escape(h),b=$("<div/>"),c=$("<a/>",{href:k,download:"raw-keypresses-"+r+".csv",html:"Raw Keypresses","class":"btn btn-success"}).appendTo(b),b.appendTo(i.$admin),i.$admin.show()})},a.prototype.outOfTime=function(){return(new Date).getTime()-this.startTime>this.maxTime()},a.prototype.startTest=function(){return j[0].makeCurrent(),this.startTime=(new Date).getTime(),i.$instructions.hide(),i.$practiceEnd.hide(),i.$sessionEnd.hide(),i.$inProgress.show(),i.$textarea.val(""),i.$textarea.focus()},a.prototype.stopTest=function(){var a;return this.isPractice?(a=i.$practiceEnd,j=_.where(d,{isPractice:!1}),this.isPractice=!1):a=i.$sessionEnd,a.show(),i.$inProgress.hide()},a.prototype.showNextSentence=function(){var a;return a=j.indexOf(g),j[a+1].makeCurrent(),i.$textarea.val(""),i.$textarea.focus()},a.prototype.initPractice=function(){return $(".practice.instructions").show(),this.isPractice=!0,j=_.where(d,{isPractice:!0})},a}(),e=new a}).call(this);